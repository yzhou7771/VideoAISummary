#!/usr/bin/env python3
"""
æ¼”ç¤ºæœåŠ¡å™¨ - ä½¿ç”¨æ¨¡æ‹Ÿè½¬å½•æ¼”ç¤ºAIæ€»ç»“åŠŸèƒ½
"""

import os
import sys
from typing import List

# æ·»åŠ serverç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(os.path.abspath(__file__)), 'server'))

from fastapi import FastAPI, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv("server/.env")

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
SUMMARY_MODEL = os.getenv("SUMMARY_MODEL", "gpt-4o-mini")

print(f"ğŸ”‘ OpenAI API Key: {'âœ… å·²é…ç½®' if OPENAI_API_KEY and OPENAI_API_KEY != 'your_openai_api_key_here' else 'âŒ æœªé…ç½®'}")

# åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
try:
    from openai import OpenAI
    client = OpenAI(api_key=OPENAI_API_KEY)
    print("âœ… OpenAI å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
except Exception as e:
    print(f"âŒ OpenAI å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: {e}")
    client = None

# å¯¼å…¥æç¤ºè¯æ¨¡æ¿
try:
    from prompts import SYSTEM_SUMMARY, USER_TEMPLATE
    print("âœ… æç¤ºè¯æ¨¡æ¿åŠ è½½æˆåŠŸ")
except ImportError:
    SYSTEM_SUMMARY = "ä½ æ˜¯èµ„æ·±æŠ•ç ”åŠ©æ‰‹ã€‚è¯·åŸºäºè½¬å½•æ–‡æœ¬ï¼Œæç‚¼ã€3â€“5æ¡ã€‘'ç»“è®º/è¦ç‚¹'ï¼Œåå‘å¯æ‰§è¡Œæˆ–åˆ¤æ–­æ€§çš„è§‚ç‚¹ã€‚è¦æ±‚ï¼š1) ç”¨ç›®æ ‡è¯­è¨€è¾“å‡ºï¼ˆé»˜è®¤ä¸­æ–‡ï¼‰ï¼›2) ä¸å¤è¿°æ— å…³ç»†èŠ‚ï¼Œä¸å±•å¼€é•¿è®ºè¿°ï¼›3) è‹¥è§†é¢‘ä»…æä¾›ä¸­æ€§ä¿¡æ¯ï¼Œåˆ™ç»™å‡ºæ¦‚è¦åˆ¤æ–­ï¼›4) ä¸ç¼–é€ æ•°æ®ï¼Œä¸ç»™å…·ä½“ä¹°å–å»ºè®®æˆ–ç›®æ ‡ä»·ï¼›5) ä»…è¿”å›è¦ç‚¹åˆ—è¡¨ï¼Œå¿…è¦æ—¶å¯é™„ä¸€è¡Œ'æ•´ä½“è§‚ç‚¹'ã€‚"
    USER_TEMPLATE = "ç›®æ ‡è¯­è¨€: {lang}\n\nä»¥ä¸‹æ˜¯è½¬å½•æ–‡æœ¬ï¼ˆå¯èƒ½å«ä¸­è‹±æ–‡æ··åˆã€å£è¯­åŒ–ï¼‰ï¼š\n\n{transcript}\n\nè¯·è¾“å‡ºï¼š\n- 3â€“5 æ¡è¦ç‚¹ï¼ˆåˆ—è¡¨ï¼Œæ¯æ¡ä¸€è¡Œï¼‰ã€‚\n- æœ«å°¾å¯é€‰'æ•´ä½“è§‚ç‚¹ï¼šâ€¦'ã€‚"

app = FastAPI(title="YouTube Video Summarizer - Demo Version", description="AI Demo with simulated transcripts")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class SummaryResp(BaseModel):
    video_id: str
    conclusions: List[str]
    summary: str
    transcript_preview: str

# æ¨¡æ‹Ÿçš„è‚¡ç¥¨åˆ†æè½¬å½•æ–‡æœ¬
DEMO_TRANSCRIPTS = {
    "XusGw6dZlH0": """
å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°é˜³å…‰è´¢ç»ã€‚ä»Šå¤©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ç¾è‚¡å¸‚åœºçš„äº”å¤§æ—ç¾¤çš„è¡¨ç°ã€‚

é¦–å…ˆæˆ‘ä»¬çœ‹ç§‘æŠ€è‚¡ï¼Œç‰¹åˆ«æ˜¯AIç›¸å…³çš„å…¬å¸ã€‚è‹±ä¼Ÿè¾¾æœ€è¿‘çš„è´¢æŠ¥è¡¨ç°ä¸é”™ï¼Œæ”¶å…¥åŒæ¯”å¢é•¿äº†ç™¾åˆ†ä¹‹äºŒç™¾å¤šï¼Œä¸»è¦æ˜¯å› ä¸ºæ•°æ®ä¸­å¿ƒå’ŒAIèŠ¯ç‰‡çš„éœ€æ±‚çˆ†å‘ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿè¦æ³¨æ„åˆ°ï¼Œç°åœ¨AIè‚¡ç¥¨çš„ä¼°å€¼å·²ç»æ¯”è¾ƒé«˜äº†ï¼ŒæŠ•èµ„è€…éœ€è¦è°¨æ…ä¸€äº›ã€‚

ç¬¬äºŒä¸ªæ—ç¾¤æ˜¯æ–°èƒ½æºæ±½è½¦ã€‚ç‰¹æ–¯æ‹‰çš„äº¤ä»˜é‡è™½ç„¶è¿˜åœ¨å¢é•¿ï¼Œä½†æ˜¯å¢é€Ÿå·²ç»æ”¾ç¼“äº†ã€‚è€Œä¸”ç°åœ¨ç«äº‰è¶Šæ¥è¶Šæ¿€çƒˆï¼Œä¼ ç»Ÿè½¦ä¼éƒ½åœ¨åŠ é€Ÿç”µåŠ¨åŒ–è½¬å‹ã€‚æˆ‘ä¸ªäººè®¤ä¸ºï¼Œè¿™ä¸ªè¡Œä¸šçš„æ´—ç‰ŒæœŸå¯èƒ½è¿˜æ²¡æœ‰ç»“æŸã€‚

ç¬¬ä¸‰æ˜¯ç”Ÿç‰©åŒ»è¯è‚¡ã€‚æœ€è¿‘FDAæ‰¹å‡†äº†å‡ ä¸ªé‡è¦çš„æ–°è¯ï¼Œç›¸å…³å…¬å¸çš„è‚¡ä»·éƒ½æœ‰ä¸é”™çš„è¡¨ç°ã€‚ä½†æ˜¯è¯ä¼çš„ç ”å‘å‘¨æœŸé•¿ï¼Œé£é™©ä¹Ÿæ¯”è¾ƒå¤§ï¼Œé€‚åˆé•¿æœŸæŒæœ‰çš„æŠ•èµ„è€…ã€‚

ç¬¬å››ä¸ªæ˜¯æ¶ˆè´¹ç±»è‚¡ç¥¨ã€‚ç”±äºé€šèƒ€å‹åŠ›å’Œæ¶ˆè´¹è€…æ”¯å‡ºçš„å˜åŒ–ï¼Œå¾ˆå¤šæ¶ˆè´¹å“å…¬å¸çš„ä¸šç»©éƒ½å—åˆ°äº†å½±å“ã€‚ä¸è¿‡ä¸€äº›æœ‰å“ç‰Œä¼˜åŠ¿çš„å…¬å¸è¿˜æ˜¯èƒ½ä¿æŒç›¸å¯¹ç¨³å®šçš„è¡¨ç°ã€‚

æœ€åæ˜¯é‡‘èè‚¡ï¼Œç‰¹åˆ«æ˜¯é“¶è¡Œã€‚éšç€åˆ©ç‡çš„å˜åŒ–ï¼Œé“¶è¡Œçš„å‡€æ¯å·®å—åˆ°äº†ä¸€äº›å½±å“ã€‚ä½†æ˜¯å¦‚æœç»æµä¿æŒç¨³å®šï¼Œé“¶è¡Œè‚¡è¿˜æ˜¯æœ‰æŠ•èµ„ä»·å€¼çš„ã€‚

æ€»çš„æ¥è¯´ï¼Œç°åœ¨ç¾è‚¡å¸‚åœºåˆ†åŒ–æ¯”è¾ƒæ˜æ˜¾ï¼ŒæŠ•èµ„è€…éœ€è¦ç²¾é€‰ä¸ªè‚¡ï¼Œä¸èƒ½ç›²ç›®è¿½é«˜ã€‚å»ºè®®å¤§å®¶é‡ç‚¹å…³æ³¨æœ‰å®é™…ä¸šç»©æ”¯æ’‘çš„å…¬å¸ï¼Œé¿å…çº¯ç²¹çš„æ¦‚å¿µç‚’ä½œã€‚

å¥½äº†ï¼Œä»Šå¤©çš„åˆ†æå°±åˆ°è¿™é‡Œï¼Œå¦‚æœå¤§å®¶æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºã€‚è®°å¾—ç‚¹èµè®¢é˜…ï¼Œæˆ‘ä»¬ä¸‹æœŸå†è§ï¼
    """,
    
    # Palantir (PLTR) åˆ†æè½¬å½•
    "pltr_demo": """
å¤§å®¶å¥½ï¼Œä»Šå¤©æˆ‘ä»¬æ¥æ·±å…¥åˆ†æPalantir Technologiesï¼Œä¹Ÿå°±æ˜¯PLTRè¿™åªè‚¡ç¥¨ã€‚

Palantiræ˜¯ä¸€å®¶ä¸“é—¨åšå¤§æ•°æ®åˆ†æçš„å…¬å¸ï¼Œä¸»è¦ä¸ºæ”¿åºœéƒ¨é—¨å’Œä¼ä¸šå®¢æˆ·æä¾›æ•°æ®é›†æˆå’Œåˆ†æå¹³å°ã€‚å…¬å¸æœ‰ä¸¤ä¸ªä¸»è¦äº§å“ï¼šGothamå¹³å°ä¸»è¦æœåŠ¡äºæ”¿åºœå’Œå›½é˜²éƒ¨é—¨ï¼ŒFoundryå¹³å°åˆ™é¢å‘å•†ä¸šå®¢æˆ·ã€‚

ä»æœ€æ–°çš„è´¢æŠ¥æ¥çœ‹ï¼ŒPalantirçš„å¢é•¿åŠ¿å¤´å¾ˆå¼ºåŠ²ã€‚å…¬å¸çš„æ€»æ”¶å…¥åŒæ¯”å¢é•¿äº†30%ä»¥ä¸Šï¼Œå…¶ä¸­å•†ä¸šå®¢æˆ·çš„å¢é•¿å°¤å…¶äº®çœ¼ï¼Œè¾¾åˆ°äº†54%çš„åŒæ¯”å¢é•¿ã€‚è¿™è¯´æ˜Palantiræ­£åœ¨æˆåŠŸæ‹“å±•å•†ä¸šå¸‚åœºï¼Œä¸å†åªä¾èµ–æ”¿åºœåˆåŒã€‚

åœ¨AIäººå·¥æ™ºèƒ½é¢†åŸŸï¼ŒPalantirçš„ä¼˜åŠ¿éå¸¸æ˜æ˜¾ã€‚ä»–ä»¬çš„AIPå¹³å°ï¼ˆArtificial Intelligence Platformï¼‰å·²ç»å¸®åŠ©å¾ˆå¤šä¼ä¸šå®¢æˆ·å®ç°äº†AIåº”ç”¨çš„å¿«é€Ÿéƒ¨ç½²ã€‚éšç€å„è¡Œå„ä¸šå¯¹AIåº”ç”¨éœ€æ±‚çš„å¢é•¿ï¼Œè¿™ä¸ºPalantiråˆ›é€ äº†å·¨å¤§çš„å¸‚åœºæœºä¼šã€‚

ä¸è¿‡æŠ•èµ„è€…ä¹Ÿéœ€è¦æ³¨æ„é£é™©ã€‚PLTRçš„ä¼°å€¼ç¡®å®ä¸ä¾¿å®œï¼Œå¸‚ç›ˆç‡ä»ç„¶æ¯”è¾ƒé«˜ã€‚è€Œä¸”å…¬å¸çš„ç›ˆåˆ©èƒ½åŠ›è¿˜æœ‰å¾…æå‡ï¼Œè™½ç„¶æ”¶å…¥å¢é•¿å¾ˆå¿«ï¼Œä½†è¦å®ç°æŒç»­ç›ˆåˆ©è¿˜éœ€è¦æ—¶é—´ã€‚

å¦å¤–ï¼ŒPalantirå¯¹æ”¿åºœåˆåŒçš„ä¾èµ–åº¦è™½ç„¶åœ¨ä¸‹é™ï¼Œä½†ä»ç„¶æ¯”è¾ƒé«˜ã€‚æ”¿åºœé¢„ç®—çš„å˜åŒ–å¯èƒ½ä¼šå½±å“å…¬å¸çš„ä¸šç»©ç¨³å®šæ€§ã€‚

æ€»ä½“æ¥è¯´ï¼Œæˆ‘è®¤ä¸ºPalantiræ˜¯ä¸€ä¸ªæœ‰æ½œåŠ›çš„é•¿æœŸæŠ•èµ„æ ‡çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨AIå’Œå¤§æ•°æ®åˆ†æé¢†åŸŸçš„é¢†å…ˆåœ°ä½å€¼å¾—å…³æ³¨ã€‚ä½†çŸ­æœŸå†…è‚¡ä»·å¯èƒ½ä¼šæœ‰æ³¢åŠ¨ï¼Œé€‚åˆé£é™©æ‰¿å—èƒ½åŠ›å¼ºçš„æŠ•èµ„è€…ã€‚
    """,
    
    # åŠ å¯†è´§å¸åˆ†æè½¬å½•
    "crypto_demo": """
å„ä½æœ‹å‹å¤§å®¶å¥½ï¼Œä»Šå¤©æˆ‘ä»¬æ¥èŠèŠæ¯”ç‰¹å¸å’ŒåŠ å¯†è´§å¸å¸‚åœºçš„æœ€æ–°åŠ¨æ€ã€‚

æ¯”ç‰¹å¸æœ€è¿‘çš„èµ°åŠ¿å¯ä»¥è¯´æ˜¯è·Œå®•èµ·ä¼ï¼Œä»é«˜ç‚¹å›è°ƒä¹‹ååˆå‡ºç°äº†ä¸€äº›åå¼¹ã€‚æˆ‘ä»¬çœ‹åˆ°æœºæ„æŠ•èµ„è€…å¯¹æ¯”ç‰¹å¸çš„æ€åº¦è¶Šæ¥è¶Šç§¯æï¼Œç‰¹åˆ«æ˜¯ä¸€äº›ä¼ ç»Ÿçš„é‡‘èæœºæ„å¼€å§‹å°†æ¯”ç‰¹å¸çº³å…¥ä»–ä»¬çš„æŠ•èµ„ç»„åˆã€‚

ä»¥å¤ªåŠæ–¹é¢ï¼Œéšç€ä»¥å¤ªåŠ2.0å‡çº§çš„æ¨è¿›ï¼Œç½‘ç»œçš„èƒ½è€—å¤§å¤§é™ä½ï¼Œè¿™å¯¹ç¯ä¿æŠ•èµ„è€…æ¥è¯´æ˜¯ä¸€ä¸ªç§¯æä¿¡å·ã€‚è€Œä¸”DeFiç”Ÿæ€ç³»ç»Ÿç»§ç»­åœ¨ä»¥å¤ªåŠä¸Šè“¬å‹ƒå‘å±•ï¼Œä¸ºETHæä¾›äº†å¼ºåŠ²çš„åŸºæœ¬é¢æ”¯æ’‘ã€‚

ä¸è¿‡æˆ‘ä»¬ä¹Ÿè¦çœ‹åˆ°ï¼Œç›‘ç®¡ç¯å¢ƒä»ç„¶æ˜¯åŠ å¯†è´§å¸å¸‚åœºé¢ä¸´çš„æœ€å¤§ä¸ç¡®å®šæ€§ã€‚å„å›½æ”¿åºœå¯¹åŠ å¯†è´§å¸çš„æ€åº¦ä¸ä¸€ï¼Œä¸€äº›ä¸¥å‰çš„ç›‘ç®¡æªæ–½å¯èƒ½ä¼šå¯¹å¸‚åœºé€ æˆçŸ­æœŸå†²å‡»ã€‚

ä»æŠ€æœ¯åˆ†æè§’åº¦æ¥çœ‹ï¼Œæ¯”ç‰¹å¸éœ€è¦çªç ´å…³é”®é˜»åŠ›ä½æ‰èƒ½ç¡®ç«‹æ–°çš„ä¸Šæ¶¨è¶‹åŠ¿ã€‚ç›®å‰çš„æˆäº¤é‡è¿˜ä¸å¤Ÿç†æƒ³ï¼Œè¯´æ˜å¸‚åœºå‚ä¸è€…ä»ç„¶æ¯”è¾ƒè°¨æ…ã€‚

å¯¹äºæ™®é€šæŠ•èµ„è€…æ¥è¯´ï¼Œæˆ‘å»ºè®®å¤§å®¶ç†æ€§å¯¹å¾…åŠ å¯†è´§å¸æŠ•èµ„ã€‚è¿™ä¸ªå¸‚åœºæ³¢åŠ¨æ€§å¾ˆå¤§ï¼Œåªç”¨è‡ªå·±æ‰¿å—å¾—èµ·æŸå¤±çš„èµ„é‡‘æ¥æŠ•èµ„ã€‚åŒæ—¶è¦åšå¥½å……åˆ†çš„ç ”ç©¶ï¼Œé€‰æ‹©æœ‰å®é™…åº”ç”¨ä»·å€¼çš„é¡¹ç›®ã€‚

æ€»çš„æ¥è¯´ï¼ŒåŠ å¯†è´§å¸ä½œä¸ºä¸€ç§æ–°å…´èµ„äº§ç±»åˆ«ï¼Œé•¿æœŸæ¥çœ‹è¿˜æ˜¯æœ‰å¾ˆå¤§å‘å±•ç©ºé—´çš„ï¼Œä½†æŠ•èµ„è€…éœ€è¦åšå¥½é£é™©ç®¡ç†ã€‚
    """,
    
    # ç§‘æŠ€è‚¡åˆ†æè½¬å½•
    "tech_demo": """
æ¬¢è¿æ”¶çœ‹ä»Šå¤©çš„ç§‘æŠ€è‚¡åˆ†æã€‚æˆ‘ä»¬æ¥é‡ç‚¹å…³æ³¨ä¸€ä¸‹æœ€è¿‘è¡¨ç°æ´»è·ƒçš„å‡ åªç§‘æŠ€è‚¡ã€‚

é¦–å…ˆæ˜¯è‹¹æœå…¬å¸AAPLã€‚è™½ç„¶iPhoneé”€é‡åœ¨æŸäº›å¸‚åœºæœ‰æ‰€ä¸‹æ»‘ï¼Œä½†æ˜¯è‹¹æœçš„æœåŠ¡ä¸šåŠ¡ç»§ç»­ä¿æŒå¼ºåŠ²å¢é•¿ã€‚App Storeã€iCloudã€Apple Musicç­‰æœåŠ¡çš„æ”¶å…¥å·²ç»å åˆ°å…¬å¸æ€»æ”¶å…¥çš„ç›¸å½“æ¯”ä¾‹ï¼Œè€Œä¸”åˆ©æ¶¦ç‡æ›´é«˜ã€‚è¿™ä¸ºè‹¹æœæä¾›äº†æ›´åŠ ç¨³å®šçš„æ”¶å…¥æ¥æºã€‚

å¾®è½¯MSFTåœ¨äº‘è®¡ç®—é¢†åŸŸçš„è¡¨ç°ä¾ç„¶äº®çœ¼ã€‚Azureå¹³å°çš„å¢é•¿é€Ÿåº¦è™½ç„¶æœ‰æ‰€æ”¾ç¼“ï¼Œä½†ä»ç„¶ä¿æŒåœ¨ä¸¤ä½æ•°å¢é•¿ã€‚ç‰¹åˆ«æ˜¯åœ¨AIé¢†åŸŸï¼Œå¾®è½¯ä¸OpenAIçš„åˆä½œè®©ä»–ä»¬åœ¨ä¼ä¸šAIåº”ç”¨æ–¹é¢å æ®äº†é¢†å…ˆåœ°ä½ã€‚

è°·æ­Œçš„æ¯å…¬å¸Alphabet GOOGLæœ€è¿‘å‘å¸ƒçš„è´¢æŠ¥æ˜¾ç¤ºï¼Œå¹¿å‘Šä¸šåŠ¡æœ‰æ‰€æ¢å¤ï¼ŒYouTubeçš„æ”¶å…¥å¢é•¿ä¹Ÿå¾ˆä¸é”™ã€‚ä¸è¿‡æŠ•èµ„è€…æ›´å…³æ³¨çš„æ˜¯è°·æ­Œåœ¨AIé¢†åŸŸçš„è¿›å±•ï¼Œç‰¹åˆ«æ˜¯Bard AIåŠ©æ‰‹èƒ½å¦ä¸ChatGPTå½¢æˆæœ‰æ•ˆç«äº‰ã€‚

Meta METAåœ¨VRå’Œå…ƒå®‡å®™é¢†åŸŸçš„æŠ•å…¥å·¨å¤§ï¼Œä½†çŸ­æœŸå†…è¿˜çœ‹ä¸åˆ°æ˜æ˜¾çš„å›æŠ¥ã€‚ä¸è¿‡ä»–ä»¬çš„å¹¿å‘Šä¸šåŠ¡æ­£åœ¨ä»å»å¹´çš„ä½è¿·ä¸­æ¢å¤ï¼Œç”¨æˆ·å¢é•¿ä¹Ÿé‡æ–°ä¼ç¨³ã€‚

æ€»ä½“æ¥è¯´ï¼Œç§‘æŠ€è‚¡çš„åŸºæœ¬é¢ä¾ç„¶ç›¸å¯¹å¥åº·ï¼Œä½†ä¼°å€¼å·²ç»ä¸ä¾¿å®œäº†ã€‚æŠ•èµ„è€…éœ€è¦æ›´åŠ ç²¾é€‰ä¸ªè‚¡ï¼Œå…³æ³¨é‚£äº›æœ‰çœŸæ­£æŠ€æœ¯ä¼˜åŠ¿å’Œå•†ä¸šæ¨¡å¼åˆ›æ–°çš„å…¬å¸ã€‚

åœ¨å½“å‰çš„å®è§‚ç¯å¢ƒä¸‹ï¼Œå»ºè®®å¤§å®¶å…³æ³¨é‚£äº›ç°é‡‘æµå……è£•ã€æœ‰å®šä»·æƒçš„ç§‘æŠ€é¾™å¤´ï¼Œé¿å…é‚£äº›çº¯æ¦‚å¿µæ€§çš„æŠ•æœºè‚¡ç¥¨ã€‚
    """,
    
    "default": """
å„ä½æŠ•èµ„è€…å¤§å®¶å¥½ï¼ä»Šå¤©æˆ‘ä»¬æ¥åˆ†æå½“å‰å¸‚åœºçš„æŠ•èµ„æœºä¼šå’Œé£é™©ã€‚

å½“å‰å…¨çƒç»æµé¢ä¸´å¤šé‡æŒ‘æˆ˜ï¼Œé€šèƒ€å‹åŠ›ã€åœ°ç¼˜æ”¿æ²»é£é™©ã€ä»¥åŠå¤®è¡Œæ”¿ç­–çš„ä¸ç¡®å®šæ€§éƒ½å¯¹å¸‚åœºäº§ç”Ÿå½±å“ã€‚åœ¨è¿™ç§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å»ºè®®æŠ•èµ„è€…ä¿æŒè°¨æ…ä¹è§‚çš„æ€åº¦ã€‚

ä»è¡Œä¸šé…ç½®æ¥çœ‹ï¼Œæˆ‘ä»¬çœ‹å¥½ä»¥ä¸‹å‡ ä¸ªæ–¹å‘ï¼šç¬¬ä¸€æ˜¯ç§‘æŠ€åˆ›æ–°é¢†åŸŸï¼Œç‰¹åˆ«æ˜¯äººå·¥æ™ºèƒ½ã€äº‘è®¡ç®—ç­‰æ–°å…´æŠ€æœ¯ï¼›ç¬¬äºŒæ˜¯æ–°èƒ½æºå’Œç¯ä¿äº§ä¸šï¼Œé•¿æœŸæˆé•¿ç©ºé—´å·¨å¤§ï¼›ç¬¬ä¸‰æ˜¯åŒ»ç–—å¥åº·ï¼Œäººå£è€é¾„åŒ–å¸¦æ¥æŒç»­éœ€æ±‚ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦è­¦æƒ•ä¸€äº›é£é™©å› ç´ ï¼šé«˜ä¼°å€¼è‚¡ç¥¨çš„å›è°ƒé£é™©ï¼ŒæµåŠ¨æ€§æ”¶ç´§å¯¹æˆé•¿è‚¡çš„å‹åˆ¶ï¼Œä»¥åŠå®è§‚ç»æµä¸‹è¡Œå¯¹å‘¨æœŸè‚¡çš„å†²å‡»ã€‚

æŠ•èµ„ç­–ç•¥ä¸Šï¼Œå»ºè®®é‡‡ç”¨åˆ†æ•£æŠ•èµ„çš„æ–¹å¼ï¼Œæ§åˆ¶å¥½ä»“ä½ï¼Œåšå¥½é£é™©ç®¡ç†ã€‚çŸ­æœŸå¯ä»¥å…³æ³¨ä¸šç»©ç¡®å®šæ€§å¼ºçš„è“ç­¹è‚¡ï¼Œé•¿æœŸå¸ƒå±€å…·æœ‰æ ¸å¿ƒç«äº‰åŠ›çš„ä¼˜è´¨æˆé•¿è‚¡ã€‚

æ€»çš„æ¥è¯´ï¼Œè™½ç„¶å¸‚åœºå­˜åœ¨ä¸ç¡®å®šæ€§ï¼Œä½†åªè¦æˆ‘ä»¬åšå¥½ç ”ç©¶ï¼Œé€‰æ‹©ä¼˜è´¨æ ‡çš„ï¼Œä¿æŒç†æ€§æŠ•èµ„ï¼Œç›¸ä¿¡è¿˜æ˜¯èƒ½å¤Ÿè·å¾—ä¸é”™çš„æ”¶ç›Šçš„ã€‚
    """
}

def get_demo_transcript(video_id: str) -> str:
    """è·å–æ¼”ç¤ºç”¨çš„è½¬å½•æ–‡æœ¬"""
    # å¦‚æœæœ‰ç‰¹å®šçš„è§†é¢‘IDæ˜ å°„ï¼Œç›´æ¥è¿”å›
    if video_id in DEMO_TRANSCRIPTS:
        return DEMO_TRANSCRIPTS[video_id]
    
    # åŸºäºè§†é¢‘IDçš„ç®€å•hashæ¥é€‰æ‹©ä¸åŒçš„demoå†…å®¹ï¼Œæä¾›æ›´å¤šæ ·åŒ–çš„æ¼”ç¤º
    import hashlib
    hash_value = int(hashlib.md5(video_id.encode()).hexdigest(), 16)
    
    # æ ¹æ®hashå€¼é€‰æ‹©ä¸åŒçš„demoè½¬å½•
    demo_keys = ["pltr_demo", "crypto_demo", "tech_demo", "default"]
    selected_key = demo_keys[hash_value % len(demo_keys)]
    
    return DEMO_TRANSCRIPTS[selected_key]

def summarize_conclusions(transcript: str, lang: str = "zh") -> tuple[List[str], str]:
    """ä½¿ç”¨GPTç”Ÿæˆç»“è®ºæ€»ç»“"""
    if not client:
        # å¦‚æœæ²¡æœ‰OpenAIå®¢æˆ·ç«¯ï¼Œè¿”å›åŸºäºè§„åˆ™çš„ç®€å•æ€»ç»“
        if lang == "zh":
            return [
                "ğŸ¤– æ¼”ç¤ºæ¨¡å¼ï¼šAIæœåŠ¡æœªé…ç½®",
                "ğŸ“Š åŸºäºè½¬å½•å†…å®¹çš„åŸºæœ¬åˆ†æ",
                "ğŸ’¡ å»ºè®®é…ç½®OpenAI APIä»¥è·å¾—å®Œæ•´AIåˆ†æ",
                "ğŸ“ˆ å½“å‰æ˜¾ç¤ºçš„æ˜¯æ¼”ç¤ºç»“æœ"
            ], "æ•´ä½“è§‚ç‚¹ï¼šæ¼”ç¤ºæ¨¡å¼ä¸‹çš„æ¨¡æ‹Ÿåˆ†æç»“æœ"
    
    print(f"ğŸ§  å¼€å§‹AIæ€»ç»“ï¼Œè¾“å…¥é•¿åº¦: {len(transcript)} å­—ç¬¦")
    
    sys_prompt = SYSTEM_SUMMARY
    user_prompt = USER_TEMPLATE.format(lang=lang, transcript=transcript[:18000])

    try:
        resp = client.chat.completions.create(
            model=SUMMARY_MODEL,
            messages=[
                {"role": "system", "content": sys_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.2,
        )
        text = resp.choices[0].message.content.strip()
        print(f"âœ… AIæ€»ç»“å®Œæˆ")

        # è§£æç»“è®º
        lines = [l.strip("- â€¢\t ") for l in text.splitlines() if l.strip()]
        conclusions = []
        overall = []
        for l in lines:
            if l.startswith("æ•´ä½“è§‚ç‚¹") or l.lower().startswith("overall"):
                overall.append(l)
            else:
                conclusions.append(l)
        return conclusions[:6], "\n".join(overall)
    
    except Exception as e:
        print(f"âŒ AIæ€»ç»“å¤±è´¥: {e}")
        # è¿”å›åŸºäºå…³é”®è¯çš„ç®€å•åˆ†æ
        if "ç§‘æŠ€" in transcript or "AI" in transcript or "è‹±ä¼Ÿè¾¾" in transcript:
            conclusions = ["ç§‘æŠ€è‚¡è¡¨ç°æ´»è·ƒï¼ŒAIæ¦‚å¿µå—å…³æ³¨", "è‹±ä¼Ÿè¾¾ç­‰èŠ¯ç‰‡è‚¡è´¢æŠ¥äº®çœ¼", "ä½†ä¼°å€¼å·²è¾¾é«˜ä½ï¼Œéœ€è°¨æ…æŠ•èµ„"]
        elif "æ–°èƒ½æº" in transcript or "ç‰¹æ–¯æ‹‰" in transcript:
            conclusions = ["æ–°èƒ½æºæ±½è½¦è¡Œä¸šç«äº‰åŠ å‰§", "ç‰¹æ–¯æ‹‰å¢é€Ÿæ”¾ç¼“ä½†ä»æœ‰ä¼˜åŠ¿", "è¡Œä¸šæ´—ç‰ŒæœŸå°šæœªç»“æŸ"]
        elif "é“¶è¡Œ" in transcript or "é‡‘è" in transcript:
            conclusions = ["é‡‘èè‚¡å—åˆ©ç‡æ”¿ç­–å½±å“", "é“¶è¡Œå‡€æ¯å·®é¢ä¸´å‹åŠ›", "ç»æµç¨³å®šä¸‹ä»æœ‰æŠ•èµ„ä»·å€¼"]
        else:
            conclusions = ["å¸‚åœºåˆ†åŒ–æ˜æ˜¾ï¼Œéœ€ç²¾é€‰ä¸ªè‚¡", "å»ºè®®å…³æ³¨ä¸šç»©æ”¯æ’‘çš„å…¬å¸", "é¿å…æ¦‚å¿µç‚’ä½œï¼Œä¿æŒç†æ€§æŠ•èµ„"]
        
        return conclusions, "æ•´ä½“è§‚ç‚¹ï¼šå½“å‰å¸‚åœºç¯å¢ƒä¸‹å»ºè®®è°¨æ…ä¹è§‚ï¼Œåšå¥½é£é™©æ§åˆ¶"

@app.get("/")
async def root():
    return {
        "message": "YouTube Video Summarizer API - Demo Version",
        "status": "running",
        "openai_configured": bool(client),
        "note": "Using simulated transcripts for demo purposes",
        "endpoints": {
            "summarize": "/api/summarize?video_id=VIDEO_ID&lang=zh",
            "docs": "/docs"
        }
    }

@app.get("/api/summarize", response_model=SummaryResp)
async def api_summarize_demo(video_id: str = Query(...), lang: str = Query("zh")):
    """æ¼”ç¤ºç‰ˆæ€»ç»“API - ä½¿ç”¨æ¨¡æ‹Ÿè½¬å½•"""
    
    print(f"ğŸ“¹ æ¼”ç¤ºæ¨¡å¼å¤„ç†è§†é¢‘: {video_id}")
    
    # è·å–æ¼”ç¤ºè½¬å½•
    transcript = get_demo_transcript(video_id)
    print(f"ğŸ“ ä½¿ç”¨æ¼”ç¤ºè½¬å½•ï¼Œé•¿åº¦: {len(transcript)} å­—ç¬¦")
    
    try:
        # AIæ€»ç»“
        conclusions, overall = summarize_conclusions(transcript, lang=lang)
        
        # ç”Ÿæˆé¢„è§ˆ
        preview = transcript[:800] + ("â€¦" if len(transcript) > 800 else "")
        
        result = SummaryResp(
            video_id=video_id,
            conclusions=conclusions,
            summary=overall,
            transcript_preview=preview,
        )
        
        print(f"ğŸ‰ æ¼”ç¤ºå¤„ç†å®Œæˆ: {len(conclusions)} æ¡ç»“è®º")
        return result
        
    except Exception as e:
        print(f"âŒ æ¼”ç¤ºå¤„ç†å‡ºé”™: {e}")
        raise HTTPException(status_code=500, detail=f"æ¼”ç¤ºå¤„ç†å¤±è´¥: {str(e)}")

if __name__ == "__main__":
    import uvicorn
    
    print("ğŸ§ª å¯åŠ¨æ¼”ç¤ºç‰ˆ YouTube æ€»ç»“æœåŠ¡...")
    print("ğŸ“¡ æœåŠ¡å°†è¿è¡Œåœ¨: http://localhost:8000")
    print("ğŸ“– API æ–‡æ¡£: http://localhost:8000/docs")
    print("ğŸ­ ä½¿ç”¨æ¨¡æ‹Ÿè½¬å½•æ¼”ç¤ºAIæ€»ç»“åŠŸèƒ½")
    print("â¹ï¸  æŒ‰ Ctrl+C åœæ­¢æœåŠ¡")
    print("-" * 60)
    
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        log_level="info"
    )